# 機能仕様書: 文書パス管理データベース

**機能ブランチ**: `001-db`
**作成日**: 2025-09-30
**ステータス**: ドラフト
**入力**: ユーザー記述: "文書のパスを管理するDB"

## 実行フロー (main)
```
1. 入力からユーザー記述を解析
   → 空の場合: ERROR "機能記述が提供されていません"
2. 記述からキーコンセプトを抽出
   → 特定: アクター、アクション、データ、制約
3. 不明確な側面ごとに:
   → [NEEDS CLARIFICATION: 具体的な質問]でマーク
4. ユーザーシナリオ＆テストセクションを記入
   → 明確なユーザーフローがない場合: ERROR "ユーザーシナリオを決定できません"
5. 機能要件を生成
   → 各要件はテスト可能でなければならない
   → 曖昧な要件をマーク
6. 主要エンティティを特定（データが関与する場合）
7. レビューチェックリストを実行
   → [NEEDS CLARIFICATION]がある場合: WARN "仕様に不確実性があります"
   → 実装詳細が見つかった場合: ERROR "技術詳細を削除してください"
8. 戻り値: SUCCESS (仕様は計画の準備完了)
```

---

## ⚡ クイックガイドライン
- ✅ ユーザーが必要とすること（WHAT）とその理由（WHY）に焦点を当てる
- ❌ 実装方法（HOW）を避ける（技術スタック、API、コード構造は記載しない）
- 👥 ビジネス関係者向けに記述、開発者向けではない

### セクション要件
- **必須セクション**: すべての機能で完了必須
- **オプションセクション**: 機能に関連する場合のみ含める
- セクションが適用されない場合は、完全に削除する（"N/A"のまま残さない）

### AI生成用
ユーザープロンプトからこの仕様を作成する際:
1. **すべての曖昧さをマーク**: 仮定が必要な場合は[NEEDS CLARIFICATION: 具体的な質問]を使用
2. **推測しない**: プロンプトで指定されていない場合（例: 認証方法なしの「ログインシステム」）はマーク
3. **テスターのように考える**: 曖昧な要件は「テスト可能で明確」チェックリスト項目で失敗すべき
4. **一般的な不足仕様領域**:
   - ユーザータイプと権限
   - データ保持/削除ポリシー
   - パフォーマンス目標とスケール
   - エラー処理動作
   - 統合要件
   - セキュリティ/コンプライアンス要件

---

## 明確化セッション

### セッション 2025-09-30

- Q: このシステムをどのように利用できるようにしますか？（CLI、ライブラリAPI、両方） → A: 両方（プログラムから利用可能なAPIとユーザーインターフェースの両方を提供）

### セッション 2025-10-01

- Q: 非存在のドキュメントIDまたは文書番号を検索した場合、システムはどのように応答すべきですか？ → A: 空の結果を返す（`Ok(None)`または空リストを返し、エラーではなく「見つからない」状態として扱う）

### セッション 2025-10-02

- Q: システムがユーザーインターフェース（FR-021）を提供する際、ユーザーが文書を作成しようとしたが、現在の期間の自動インクリメントカウンターが上限に達している場合、どうすべきですか？ → A: エラーメッセージのみ表示して作成をブロック
- Q: 文書の論理削除（FR-012）を行った後、削除された文書は検索結果に表示されるべきですか？ → A: デフォルトで非表示（通常の検索では表示しない）
- Q: 文書番号生成ルール（PathGenerationRule）の設定を変更できるのは誰ですか？ → A: 各部門の管理者（自部門のルールのみ）
- Q: システムの障害発生時、データベースのバックアップやリカバリー機能が必要ですか？ → A: 外部ツールに委譲（システムは提供しない）
- Q: 業務タスク（BusinessTask）は誰が作成・管理しますか？ → A: 各部門の管理者（自部門のタスクのみ、管理の企画営業部も可能）
- Q: 文書新規作成時に、文書番号とファイルパス以外に、ユーザーが入力すべき情報はありますか？ → A: タイトル（必須）、備考（オプション）、版番号（バージョン管理用）を入力。ファイルパスは年月と文書種類からルールによって自動生成される
- Q: 版番号（Version number）の管理方法について、システムはどのように扱うべきですか？ → A: 版番号は単なるメタデータ（履歴管理なし）
- Q: 文書のタイトルや備考フィールドで検索できる必要がありますか？ → A: タイトルのみ部分一致検索
- Q: 文書作成時、業務タスク（BusinessTask）の選択は必須ですか？ → A: オプション（業務タスクなしでも作成可能）
- Q: 文書作成時に文書種類（DocumentType）をユーザーが選択する際、どのように表示・選択しますか？ → A: 自分の部署・課で利用可能な文書種類のみリスト表示（チェックボックスのデフォルトが自部署になっているが、切り替え可能。権限管理は不要）
- Q: ファイルパスがディスク上に実際に存在するかどうかをシステムで追跡する必要がありますか？ → A: オプショナル機能として提供（将来的な拡張として検討、初期実装では不要）
- Q: このシステムで管理する文書パスの想定数はどのくらいですか？ → A: 中規模（約10,000件）- チームや部門での利用レベル
- Q: このシステムは複数のユーザーが同時にアクセスすることを想定していますか？ → A: 複数ユーザー（読み取りのみ共有）- 複数ユーザーが同時に閲覧可能だが、更新は排他的
- Q: 同じファイルパスを複数回登録しようとした場合、システムはどう動作すべきですか？ → A: 文書種類ごとにルールベースでパスを自動生成し、rootディレクトリとパス生成ルールを定義することで一意性を保証
- Q: システムは絶対パスと相対パス、どちらを扱いますか？ → A: 絶対パスのみ。WindowsのUNCパス（\\server\share\...形式のネットワークパス）もサポート
- Q: ユーザーが文書へのアクセスや作成を試みる際、システムはどのような認証・認可メカニズムを使用すべきですか？ → A: 最終的には外部認証委譲（SSO/LDAP/AD）だが、当初は認証なし（ホスティング環境で事前認証済みと想定し、部署/課の権限チェックのみ実施）
- Q: システムがログ、メトリクス、監視データを生成する必要がありますか？運用上の可観測性（observability）についてどのレベルが必要ですか？ → A: 不要 - ログや監視機能は必要なし
- Q: 文書パスデータの保持期間やアーカイブ、削除ポリシーについて、どのように扱うべきですか？ → A: AおよびD（永続保持 + 論理削除 - 削除フラグを立てるが実データは保持、監査目的）
- 追加要件: ユーザーと文書種類は部署に紐づく。文書は業務に紐づく。
- 文書番号フォーマット: **文書種類ごとに異なるルールを定義可能**
  - 例1: AGI-2509001 = A(文書種類) + G(部門) + I(課) + 2509(年月) + 001(連番)
  - 例2: りん議I-25009 = りん議(文書種類) + I(課) + - + 25(年) + 009(連番、月なし)
  - 各文書種類に対して、独自の番号生成ルール（使用する要素、順序、セパレーター、桁数など）とrootディレクトリを定義

---

## ユーザーシナリオとテスト *(必須)*

### 主要ユーザーストーリー

部門ユーザーとして、各文書種類が独自の番号フォーマットとrootディレクトリを持つ柔軟なルールベース自動パス生成システムを通じて文書ファイルパスを管理したい。これにより、パス情報を手動で維持することなく、異なる文書種類要件に応じて文書を効率的に整理できる。

### 受入シナリオ

1. **前提条件**: 文書種類"A"がルールフォーマット`[Type][Dept][Section]-[YYMM][NNN]`とrootディレクトリ`/docs/contracts/`で定義されている、**条件**: GI課のユーザーが2025年9月にタイトル「契約審査文書」でタイプAの新規文書を作成、**期待結果**: システムは文書番号"AGI-2509001"を生成し、パス`/docs/contracts/AGI-2509001.pdf`を保存し、タイトルとオプションの備考を保存する
2. **前提条件**: 文書種類"りん議"がルールフォーマット`[Type][Section]-[YY][NNN]`とrootディレクトリ`/docs/ringi/`で定義されている、**条件**: I課のユーザーが2025年にりん議文書を作成、**期待結果**: システムは文書番号"りん議I-25009"を生成し、パス`/docs/ringi/りん議I-25009.pdf`を保存する
3. **前提条件**: 私が部門"K"課"T"のユーザーである、**条件**: 文書を作成する、**期待結果**: システムは自分の部門と課用に設定された文書種類を使用する
4. **前提条件**: 文書が作成されている、**条件**: 業務タスクに関連付ける、**期待結果**: システムは業務タスク参照を保存する
5. **前提条件**: データベースが空である、**条件**: 新しい文書パスを追加する、**期待結果**: パスが正常に保存され、一意の識別子が割り当てられる
6. **前提条件**: データベースに文書パスが存在する、**条件**: 文書番号で検索する（例: "AGI-2509001"または"りん議I-25009"）、**期待結果**: システムは正しい文書パスを返す
7. **前提条件**: 複数の文書パスが存在する、**条件**: すべてのパスを照会する、**期待結果**: システムは保存されたパスの完全なリストを返す
8. **前提条件**: 文書パスが存在する、**条件**: そのパス値を更新する、**期待結果**: 新しいパスが保存され、文書番号は変更されない
9. **前提条件**: 文書パスが存在する、**条件**: 文書番号で削除する、**期待結果**: パスがデータベースから削除される
10. **前提条件**: パス生成ルールを持つ文書種類がある、**条件**: 種類別に文書を照会する、**期待結果**: システムはその文書種類のすべてのパスを返す
11. **前提条件**: 私が部門のユーザーである、**条件**: 業務タスク別に文書を照会する、**期待結果**: システムはそのタスクに関連付けられたすべての文書を返す
12. **前提条件**: タイプ"りん議"の複数の文書が25年に存在する、**条件**: 自動インクリメントがりん議I-25999に達する、**期待結果**: システムはカウンターオーバーフローを適切に処理する

### エッジケース

- 重複パスが追加された場合どうなりますか？ システムはルールベースのパス生成により重複を防止しなければならない
- システムは無効なファイルパスをどのように処理しますか？ システムはパスフォーマット（Unix/Linux、Windowsローカルドライブ、Windows UNCパスの絶対パス）を検証し、無効なフォーマットを拒否しなければならない
- 存在しない識別子を照会した場合どうなりますか？ システムはエラーではなく空の結果（単一文書照会では`Ok(None)`、検索照会では空リスト）を返さなければならない
- 複数のユーザーが同時に同じパスを更新しようとした場合どうなりますか？ システムは同時書き込み試行を拒否し、ユーザーに通知しなければならない
- パスがディスク上に存在しないファイルを指す場合どうなりますか？ システムは初期実装でファイル存在を追跡しない（パスメタデータのみ）；ファイル存在検証はオプショナルな将来の拡張として追加される可能性がある
- 自動インクリメントカウンターが最大値（999または設定桁数制限）に達した場合どうなりますか？ システムはカウンター枯渇を示すエラーを返し、文書作成をブロックし、ユーザーにエラーメッセージを表示しなければならない。月ベースのカウンターの場合、カウンターは次の月にリセットされる；年ベースのカウンターの場合、カウンターは次の年にリセットされる。ユーザーは期間のロールオーバーを待つか、手動入力（FR-008）を回避策として使用しなければならない。
- システムは既存文書のパス生成ルール変更をどのように処理しますか？ システムは以前に生成されたパスとの後方互換性を維持しなければならない（既存文書は元の番号を保持する）
- システムはクロスプラットフォームパスの違い（Unix/Windows）をどのように処理しますか？ システムはパスをそのまま保存し、プラットフォーム固有のフォーマットを正しく処理しなければならない
- ユーザーが自分の部門と課に通常関連付けられていない種類の文書を作成しようとした場合どうなりますか？ システムは作成を許可する（アクセス制限なし）が、UIは便宜上ユーザーの部門/課の種類をデフォルトで表示する
- システムは部門再編（ユーザーが部門間を移動）をどのように処理しますか？ システムは部門更新を許可しながら、歴史的な文書所有権を維持しなければならない
- システムは文書種類コード（りん議、教育）のマルチバイト文字をファイルパスでどのように処理しますか？ システムはUTF-8または他の適切な文字エンコーディングを適切にエンコードおよび処理しなければならない

---

## 要件 *(必須)*

### 用語ガイドライン
- **DocumentPath（文書パス）**: システム内の主要エンティティ。一意の識別子とメタデータを持つ保存されたファイルパスを表す。
- **document（文書）**: 一般的な文脈で使用可能。DocumentPathエンティティを指す場合は「DocumentPath」を明示。

### 機能要件

- **FR-001**: システムは一意の識別子を持つ文書ファイルパスを保存しなければならない
- **FR-002**: システムはカスタマイズ可能なパス生成ルールで文書種類を定義しなければならない
- **FR-003**: システムは文書種類ごとに柔軟な文書番号フォーマット定義をサポートしなければならない。以下の設定が可能:
  - 含める構成要素（文書種類名、部門コード、課コード、年、月、自動インクリメント）
  - 構成要素の順序と位置
  - セパレーター（例: "-"、セパレーターなしなど）
  - 各構成要素の桁数
  - 年フォーマット（2桁または4桁）
  - 月構成要素を含めるかどうか
  - これらの設定とカウンタースコープ設定を定義・管理するPathGenerationRuleエンティティ
- **FR-004**: システムは以下の文書種類コードをサポートしなければならない: A（契約上必要な提出文書）、C（社内メモ）、D（入手した文書）、Q（品質関連文書）、りん議（稟議書）、教育（研修記録）、および他のカスタマイズ可能な種類
- **FR-005**: システムはGI（総務G、インフラI）、KT（分析K、技術T）などの部門・課コードおよび他の組織単位をサポートしなければならない
- **FR-006**: システムは文書種類固有のルールに基づいて文書番号とファイルパスを自動生成しなければならない（ルールフォーマットに従った番号生成 + rootディレクトリと生成番号を組み合わせたパス構築）
- **FR-007**: システムは文書種類ルールごとに定義されたスコープで自動インクリメントカウンターを維持しなければならない（例: 種類+課+年ごと、または種類+年ごとなど）
- **FR-008**: システムは自動生成が適用できない場合に手動指定文書番号での文書パス手動追加を許可しなければならない（生成ルールは手動エントリには適用されない）
- **FR-009**: システムは保存されたすべての文書パスの照会を許可しなければならない（フィルタリングなしの単純なリスト取得）
- **FR-010**: システムは文書種類でフィルタリングされたパスの照会を許可しなければならない
- **FR-011**: システムは既存文書パスの更新を許可しなければならない
- **FR-012**: システムは識別子による文書パスの論理削除を許可しなければならない（ブール値フラグで削除マークを付けるが、監査目的でデータを無期限に保持）；削除された文書はデフォルトの検索結果および照会操作から除外されなければならない
- **FR-013**: システムはアプリケーション再起動を超えて文書パスデータを永続化しなければならない（明示的に削除されない限り無期限保持）
- **FR-014**: システムは約10,000件の文書パスを効率的に処理しなければならない（照会応答時間<100ms、文書作成<10ms）
- **FR-015**: システムは文書番号、文書種類、部門、課、業務タスク、およびタイトル（部分一致）によるパス検索機能を提供しなければならない（フィルタ付き高度検索）；論理削除された文書をデフォルトで除外
- **FR-016**: システムは読み取り操作で複数の同時ユーザーをサポートしなければならない
- **FR-017**: システムは書き込み操作（更新と削除）で排他的アクセスを強制しなければならない
- **FR-018**: システムは保存前に絶対ファイルパスを検証しなければならない
- **FR-019**: システムはローカル絶対パス（例: /home/user/docsまたはC:\Users\docs）とWindows UNCネットワークパス（例: \\server\share\docs）の両方をサポートしなければならない
- **FR-020**: システムは作成タイムスタンプと最終更新タイムスタンプを含むメタデータ保存をサポートしなければならない
- **FR-021**: システムはパスデータにアクセスするためのプログラマティックAPIとユーザーインターフェースの両方を提供しなければならない；ユーザーインターフェースは操作失敗時に明確なエラーメッセージを表示しなければならない（例: カウンター枯渇、検証失敗、同時書き込み競合）
- **FR-022**: システムは他のアプリケーションとの統合のためのプログラマティックアクセスを許可しなければならない
- **FR-023**: システムは文書種類ごとのパス生成ルールの設定と変更をサポートしなければならない。変更は新規文書にのみ適用される（既存文書は後方互換性のため元の番号とパスを保持）；部門管理者のみが自部門の文書種類のルールを変更可能
- **FR-024**: システムはユーザーを部門と課に関連付けなければならない
- **FR-025**: システムは文書種類を特定の部門と課の組み合わせに関連付けなければならない；ユーザーインターフェースはデフォルトでユーザーの部門/課に関連する文書種類をフィルタリングして表示すべきであるが、他の種類を表示/選択するオプションあり（部門ベースの文書種類制限の厳格な強制なし）
- **FR-026**: システムは文書を業務タスクに関連付けることを許可しなければならない（オプショナルな関連付け）
- **FR-027**: システムは部門別の文書照会を許可しなければならない
- **FR-028**: システムは課別の文書照会を許可しなければならない
- **FR-029**: システムは業務タスク別の文書照会を許可しなければならない
- **FR-030**: システムユーザーインターフェースはデフォルトでユーザーの部門と課の文書種類を表示すべきであるが、アクセス制限なしですべての利用可能な文書種類を表示するように切り替え可能
- **FR-031**: システムは単一バイト（A、C、D、Q）とマルチバイト（りん議、教育）の文書種類識別子の両方をサポートしなければならない
- **FR-032**: システムは文書種類ごとにrootディレクトリパスの設定を許可しなければならない。ローカル絶対パスとWindows UNCパスの両方をサポート
- **FR-034**: システムはユーザーIDと部門/課割り当てのための外部認証プロバイダー（SSO、LDAP、Active Directory）との将来的な統合をサポートすべきである
- **FR-035**: システムは初期段階でビルトイン認証なしで動作してもよい。ユーザーがホスティング環境で事前認証済みであると想定
- **FR-036**: システムは一般ユーザーと部門管理者を区別しなければならない；部門管理者は自部門に属する文書種類のパス生成ルールを設定可能
- **FR-037**: システムはビルトインバックアップまたはリカバリー機能を提供しない；バックアップと災害復旧は外部データベース管理ツールおよびホスティング環境インフラに委譲
- **FR-038**: システムは部門管理者が自部門の業務タスクを作成・管理することを許可しなければならない；一般ユーザーは既存タスクの表示と選択のみ可能
- **FR-039**: システムは新規文書作成時にタイトルを要求しなければならない（ユーザー入力、必須フィールド）
- **FR-040**: システムは追加文書情報のためのオプショナルな備考フィールドを許可しなければならない
- **FR-041**: システムはメタデータのみとして文書のバージョン番号追跡をサポートしなければならない（ユーザー提供フィールド；自動バージョン履歴または文書番号ごとの複数バージョンなし）
- **FR-042**: システムは部分一致（部分文字列検索）を使用したタイトルによる文書検索を許可しなければならない

### 主要エンティティ *(機能がデータを含む場合に含める)*

- **Department（部門）**: 組織内の部門を表す
  - 一意の部門コード（1文字、例: "G"は総務、"K"は分析）
  - 部門名
  - 部門内の課のリスト

- **Section（課）**: 部門内の課を表す
  - 一意の課コード（1文字、例: "I"はインフラ、"T"は技術）
  - 課名
  - 部門参照（親部門）
  - 課に属するユーザーのリスト

- **User（ユーザー）**: 文書を作成・管理するシステムユーザーを表す
  - 一意のユーザー識別子
  - ユーザー名
  - 部門参照
  - 課参照（各ユーザーは1つの部門と1つの課に属する）
  - ユーザー役割（一般ユーザーまたは部門管理者）
  - アクセス権限

- **BusinessTask（業務タスク）**: 文書がサポートするビジネス活動またはタスクを表す
  - 一意のタスク識別子
  - タスク名/説明
  - 部門参照（このタスクを所有する部門）
  - 課参照（タスクが課固有の場合はオプショナル）
  - 作成者（このタスクを作成した部門管理者）
  - アクティブ/非アクティブステータス

- **DocumentType（文書種類）**: 関連するパス生成ルールを持つ文書のカテゴリーを定義
  - 文書種類コード（1-3文字、例: "A"、"C"、"D"、"Q"、"りん議"、"教育"）
  - 文書種類説明（例: "契約上必要な提出文書"、"社内メモ"、"入手した文書"）
  - 部門コード参照（この種類が属する部門、種類が複数部門にまたがる場合はオプショナル）
  - 課コード参照（この種類が属する課、種類が複数課にまたがる場合はオプショナル）
  - Rootディレクトリパス（この文書種類の絶対パスまたはWindows UNCパス）
  - パス生成ルール参照（柔軟な番号フォーマットを定義）
  - アクティブ/非アクティブステータス

- **DocumentPath（文書パス）**: 一意の識別子と関連メタデータを持つ保存されたファイルパスを表す
  - 一意のシステム識別子（システム生成）
  - 文書番号（文書種類のルールに従って生成、例: "AGI-2509001"、"りん議I-25009"）
  - タイトル（ユーザー提供、必須）
  - 備考（ユーザー提供、オプショナル）
  - バージョン番号（ユーザー提供、バージョン管理用）
  - 文書種類参照
  - 部門コード（文書番号またはユーザーコンテキストから抽出）
  - 課コード（文書番号またはユーザーコンテキストから抽出）
  - 業務タスク参照（この文書がサポートする業務タスク；オプショナル）
  - ユーザー参照（文書を作成/所有したユーザー）
  - ファイルパス（絶対パス: Unix/Linuxフォーマット、Windowsローカルドライブ、またはWindows UNCネットワークパス；パス生成ルールに基づいてrootディレクトリ + 文書番号から自動生成）
  - 作成タイムスタンプ
  - 最終更新タイムスタンプ
  - 生成/手動入力フラグ（文書番号が自動生成されたか手動指定されたかを示す）
  - 削除フラグ（監査目的の論理削除、無期限保持）

- **PathGenerationRule（パス生成ルール）**: 文書種類の文書番号が自動的にどのように構築されるかを定義（種類ごとに完全に柔軟）
  - ルール識別子
  - 関連文書種類
  - 構成要素設定（番号に表示される内容を定義する順序付きリスト）:
    - 構成要素タイプ（document_type_name、department_code、section_code、year、month、auto_increment）
    - シーケンス内の構成要素位置
    - 桁数（年、月、インクリメントなどの数値構成要素用）
    - 年フォーマット（2桁または4桁）
  - セパレーター設定（構成要素間のセパレーターを定義、例: "-"、セパレーターなしなど）
  - 自動インクリメントカウンタースコープ（カウンターをリセットするもの: 種類のみ、種類+年、種類+課+年など）
  - 自動インクリメント桁数
  - 出力例（例: フォーマット[Type][Dept][Section][YYMM][NNN]の場合"AGI-2509001"、[Type][Section]-[YY][NNN]の場合"りん議I-25009"）

---

## レビュー＆受入チェックリスト
*GATE: main()実行中に自動チェック実行*

### コンテンツ品質
- [x] 実装詳細なし（言語、フレームワーク、API）
- [x] ユーザー価値とビジネスニーズに焦点
- [x] 非技術関係者向けに記述
- [x] すべての必須セクション完了

### 要件完全性
- [x] [NEEDS CLARIFICATION]マーカーが残っていない
- [x] 要件はテスト可能で明確
- [x] 成功基準は測定可能
- [x] スコープは明確に境界設定
- [x] 依存関係と前提条件が特定済み

---

## 実行ステータス
*main()処理中に更新*

- [x] ユーザー記述解析済み
- [x] キーコンセプト抽出済み
- [x] 曖昧さマーク済み
- [x] ユーザーシナリオ定義済み
- [x] 要件生成済み
- [x] エンティティ特定済み
- [x] レビューチェックリスト合格（2件の影響の少ない明確化を延期）

---

**✅ SUCCESS**: 仕様は計画フェーズの準備完了。

**明確化完了**: すべての曖昧さを3セッション（合計20質問以上）で解決。

**次のステップ**: `/plan`コマンドを実行して実装計画フェーズに進む。
